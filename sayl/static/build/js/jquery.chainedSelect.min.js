
(function($){$.fn.chainedSelect=function(options){var settings=$.extend({},$.fn.chainedSelect.defaults,options);var cache=settings.cacheClass(settings);return this.each(function(){var $$=$(this);var opts=$.metadata?$.extend({},settings,$$.metadata()):settings;var showPreloader,hidePreloader;if(opts.preloadUrl){opts.preloader=$('<img />').css({position:'absolute',border:'none',display:'none'}).attr('src',opts.preloadUrl);$$.after(opts.preloader);showPreloader=function(){opts.preloader.css({left:$$.position().left+$$.outerWidth()+5,top:$$.position().top+($$.outerHeight()/2)-8}).show();}
hidePreloader=function(){opts.preloader.hide();}}else{showPreloader=hidePreloader=function(){};}
if(!(opts.parent instanceof $))opts.parent=$(opts.parent);opts.parent.change(function(){var param=$(this).val();var key=$(this).attr('id')+'::'+param;$$.attr('disabled','disabled');var data=cache.getItem(key);if(data){addOptions($$,opts,data);}else{showPreloader();$.ajax({url:opts.url,data:{'q':param},type:(opts.type||'get'),dataType:'json',global:false,success:function(data){addOptions($$,opts,data);hidePreloader();cache.setItem(key,data);},error:function(xhr,msg,e){if(opts.error)opts.error(xhr,msg,e);}});}});if(opts.parent.val()){opts.parent.trigger('change');}});}
function addOptions(target,opts,data){var curValue=target.val();target.empty();for(i=0;i<data.length;i++){var value,label;if(typeof data[i]=='object'){value=data[i][opts.value];label=data[i][opts.label];}else{value=label=data[i];}
target.get(0).options[i]=new Option(label,value);}
if(curValue){target.val(curValue);}else{target.find('option:first').attr('selected','selected');}
target.attr('disabled','').trigger('change');}
$.fn.chainedSelect.Cache=function(opts){var cache={},keys=[];return{getItem:function(key){if(key in cache)return cache[key];else return null;},setItem:function(key,value){if(value){cache[key]=value;var length=keys.push(key);if(length>opts.cacheLength){delete cache[keys.shift()];}}},clear:function(){cache={};keys=[];}}};$.fn.chainedSelect.defaults={value:'pk',label:'name',preloadUrl:'',cacheClass:$.fn.chainedSelect.Cache,cacheLength:10,error:null}})(jQuery);